{% extends "base.html" %}
{% block title %}Trade{% endblock %}

{% block main %}
  <div align="center">
    <h5>username : {{ username }}</h5>
    <h5>cash : <span id='cash'></span></h5>
  </div>

<br><br><br>

<div class="container">
  <div class="row">
    
    <div class="col-4"align="center">
      <form action="" method="post">
        {% csrf_token %}
        <h4>BTC/JPY</h4>
        best_ask : <span id='btc_jpy_best_ask'></span><br>
        best_bid : <span id='btc_jpy_best_bid'></span><br><br>
        <p>数量 : <input type="text" name="btc_jpy_amount" size="5"></p>
        <input type="submit" value="売り" name="btc_jpy_make_order" class="btn btn-danger">
        <input type="submit" value="買い" name="btc_jpy_make_order" class="btn btn-warning">
      </form>
    </div>
    
    <div class="col-4" align="center">
      <form action="" method="post">
        {% csrf_token %}
        <h4>USD/JPY</h4>
        best_ask : <span id='usd_jpy_best_ask'></span><br>
        best_bid : <span id='usd_jpy_best_bid'></span><br><br>
        <p>数量 : <input type="text" name="usd_jpy_amount" size="5"></p>
        <input type="submit" value="売り" name="usd_jpy_make_order" class="btn btn-danger">
        <input type="submit" value="買い" name="usd_jpy_make_order" class="btn btn-warning">
      </form>
    </div>
    
    
    <div class="col-4" align="center">
      <form action="" method="post">
        {% csrf_token %}
        <h4>日経225/JPY</h4>
        best_ask : <span id='nikkei_jpy_best_ask'></span><br>
        best_bid : <span id='nikkei_jpy_best_bid'></span><br><br>
        <p>数量 : <input type="text" name="nikkei_jpy_amount" size="5"></p>
        <input type="submit" value="売り" name="nikkei_jpy_make_order" class="btn btn-danger">
        <input type="submit" value="買い" name="nikkei_jpy_make_order" class="btn btn-warning">
      </form>
    </div>
  </div>
</div>



<br><br><br>
<h5>現在取引中の注文</h5>
  <table border="1" class="table table-striped">
    <tr>
      <th>ペア</th>
      <th>売・買</th>
      <th>数量</th>
      <th>建値</th>
      <th>日付</th>
      <th></th>
    </tr>
    {% for position in position_list %}
      <tr>
        <td>{{ position.0 }}</td>
        <td>{{ position.1 }}</td>
        <td>{{ position.2 }}</td>
        <td>{{ position.3 }}</td>
        <td>{{ position.4 }}</td>
        <td><button type="button" id="liquidation" class="btn btn-primary">
            <input type="hidden" value={{ position.0 }} id="position0">
            <input type="hidden" value={{ position.1 }} id="position1">
            <input type="hidden" value={{ position.2 }} id="position2">
            <input type="hidden" value={{ position.3 }} id="position3">
            <input type="hidden" value={{ position.4 }} id="position4">
            <input type="hidden" value={{ position.5 }} id="position5">
            ポジションの清算
            </button>
        </td>
      </tr>
    {% endfor %}
  </table>

<br><br><br><br>

<table border="1" class="table table-striped">
  <tr>
    <th>ペア</th>
    <th>売・買</th>
    <th>数量</th>
    <th>建値</th>
    <th>日付</th>
    <th></th>
  </tr>
  <tbody id="tbodyID">
    <!-- ここをループ -->
  </tbody>
</table>

{% endblock %}

{% block JavaScript %}
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <script>
      var username = '{{ username }}';
      var socket = new WebSocket('ws://' + window.location.host + '/ws/trade/' + username + '/');
      
      socket.onopen = function open() {
        socket.send(JSON.stringify({"open":"{{ username }}"}));
        console.log('WebSockets connection created.');
      };
      
      socket.onmessage = function(e) {
        var data = JSON.parse(e.data);
        console.log(data);
        
        if ('btc_jpy_best_bid' in data) {
          var btc_jpy_best_bid = data['btc_jpy_best_bid'];
          var btc_jpy_best_ask = data['btc_jpy_best_ask'];
          var usd_jpy_best_bid = data['usd_jpy_best_bid'];
          var usd_jpy_best_ask = data['usd_jpy_best_ask'];
          var nikkei_jpy_best_bid = data['nikkei_jpy_best_bid'];
          var nikkei_jpy_best_ask = data['nikkei_jpy_best_ask'];
          var btc_jpy_best_bid_element = document.getElementById('btc_jpy_best_bid');
          var btc_jpy_best_ask_element = document.getElementById('btc_jpy_best_ask');
          var usd_jpy_best_bid_element = document.getElementById('usd_jpy_best_bid');
          var usd_jpy_best_ask_element = document.getElementById('usd_jpy_best_ask');
          var nikkei_jpy_best_bid_element = document.getElementById('nikkei_jpy_best_bid');
          var nikkei_jpy_best_ask_element = document.getElementById('nikkei_jpy_best_ask');
          btc_jpy_best_bid_element.textContent = btc_jpy_best_bid.toLocaleString();
          btc_jpy_best_ask_element.textContent = btc_jpy_best_ask.toLocaleString();
          usd_jpy_best_bid_element.textContent = usd_jpy_best_bid.toLocaleString();
          usd_jpy_best_ask_element.textContent = usd_jpy_best_ask.toLocaleString();
          nikkei_jpy_best_bid_element.textContent = nikkei_jpy_best_bid.toLocaleString();
          nikkei_jpy_best_ask_element.textContent = nikkei_jpy_best_ask.toLocaleString();
        };
        if ('cash' in data) {
          var cash = data['cash'];

          
          var cash_element = document.getElementById('cash');

          
          cash_element.textContent = cash.toLocaleString();

        };
        
        if ('position_list' in data) {
          console.log("position_list")
          var position_list = data["position_list"]
          var tbody = document.getElementById('tbodyID');

          for (var i=0,l=position_list.length;i<l;i++){
            var tr = document.createElement('tr');
            var position = position_list[i]
            for (j = 0; j < 5; j++){
              var td = document.createElement('td');
              td.innerHTML = position[j];
              //td.innerHTML = '<input type="hidden" value=' + position[j] + ' id="position' + j +  '">';
              tbody.appendChild(td);
            };
            var td = document.createElement('td');
            td.innerHTML = '<button type="button" id="liquidation" class="btn btn-primary">ポジションの清算</button>';
            tbody.appendChild(td);
            
            tbody.appendChild(tr);
          };
        };
        
      };
      
      socket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
      };
      
      document.getElementById("liquidation").onclick = function() {
        liquidation_json = {
          "liquidation":true,
          "username":"{{ username }}",
          "pair":document.getElementById("position0").value,
          "ls":document.getElementById("position1").value,
          "amount":document.getElementById("position2").value,
          "price":document.getElementById("position3").value,
          "timestamp":document.getElementById("position5").value
        };
        console.log(liquidation_json);
        socket.send(JSON.stringify(liquidation_json));
      };
      
    </script>
{% endblock %}


